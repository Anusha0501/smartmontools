#!/bin/sh
#
# Create svnversion.h file or get package version
#
# Home page of code is: https://www.smartmontools.org
#
# Copyright (C) 2024-25 Christian Franke
#
# SPDX-License-Identifier: GPL-2.0-or-later
#

set -e
myname=$0

usage()
{
  cat <<EOF
Usage: $myname [-i] [-pq] [-r] [> svnversion.h]

  -i          Print new contents of svnversion.h
  -p          Print package version from configure.ac
  -q          Prepend 'pre-' to package version if pre-release (implies -p)
  -r          Print emulated svn revision (like 'svnversion')
EOF
  exit 1
}

error()
{
  echo "$myname: $*" >&2
  exit 1
}

i_opt=false; p_opt=false; q_opt=false; r_opt=false
while true; do case $1 in
  -i) i_opt=true ;;
  -p) p_opt=true ;;
  -q) p_opt=true; q_opt=true ;;
  -r) r_opt=true ;;
  -*) usage ;;
  *) break ;;
esac; shift; done
test $# -eq 0 || usage
$i_opt || $p_opt || $r_opt || usage

srcdir=${myname%/*}
test "$srcdir" != "$myname" || error 'unknown $srcdir'

files="
  ChangeLog NEWS Makefile.am configure.ac smart*.in
  *.cpp *.h os_win32/*.cpp os_win32/*.h
"
(cd "$srcdir" && ls -d $files >/dev/null) || error "sources not found in $srcdir"

revision_from_git()
{
  local h r t x
  x=$(cd "$srcdir" && TZ='' LC_ALL=C git log -1 --date=iso 2>/dev/null) || return 1
  h=$(echo "$x" | sed -n 's,^commit \([0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]\).*$,\1,p')
  t=$(echo "$x" | sed -n 's,^Date: *\(2[-0-9]*\) \([0-9][:0-9]*\) .*$,\1 \2,p')

  # 943adaed: r5714 - RELEASE_7_5 svn/trunk commit
  r=$(cd "$srcdir" && git rev-list --count 943adaed..HEAD 2>/dev/null) || return 1
  r=$((5714 + r))

  test "${h:+y}${r:+y}${t:+y}" = "yyy" || return 1
  test -z "$(cd "$srcdir" && git status -s -uno 2>&1)" || r="${r}M"
  svnrev=$r; revdate=${t% *}; revtime=${t#* }; githash=$h
  origin="git log"
}

if $i_opt || $r_opt; then
  svnrev=; revdate=; revtime=; githash=
  origin="missing information"
  revision_from_git

  if $i_opt; then
    # TODO: rename include file and variables
    cat <<EOF
/* svnversion.h.  Generated by ${myname##*/} from $origin.  */
EOF
    test -z "$svnrev" || cat << EOF
#define SMARTMONTOOLS_SVN_REV  "$svnrev"
#define SMARTMONTOOLS_SVN_DATE "$revdate"
#define SMARTMONTOOLS_SVN_TIME "$revtime"
#define SMARTMONTOOLS_GIT_HASH "$githash"
EOF
  fi

  if $r_opt; then
    test -n "$svnrev" || error "svn revision not found using $methods"
    echo "$svnrev"
  fi
fi

if $p_opt; then
  p=$(sed -n 's|^AC_INIT[^,]*, *\[\([0-9.]*\)\] *,.*$|\1|p' "$srcdir/configure.ac") || exit 1
  test -n "$p" || error "package version not found in $srcdir/configure.ac"
  if $q_opt; then
    x=$(sed -n 's|^smartmontools_release_date=\(.*\)$|\1|p' "$srcdir/configure.ac") || exit 1
    case $x in
      20*) ;;
      \ \#*) p="pre-$p" ;;
      *) error "unable to detect pre-release state in $srcdir/configure.ac"
    esac
  fi
  echo "$p"
fi
